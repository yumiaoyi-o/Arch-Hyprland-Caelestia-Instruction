#!/usr/bin/env bash
set -euo pipefail

# injected env for icon theme and qt platform theme
export QS_ICON_THEME="Papirus"
export XDG_DATA_DIRS="/usr/share:/home/$USER/.local/share"
export QT_QPA_PLATFORMTHEME="qt5ct"

set -euo pipefail

# Lightweight wrapper: only support --forced-dpi <value>
# Usage: caelestia-forceddpi --forced-dpi 144 shell -d

dpi=""
cmd=( )

while (( "$#" )); do
  case "$1" in
    --forced-dpi=*|--forceddpi=*) dpi="${1#*=}"; shift ;;
    --forced-dpi|--forceddpi)
      if [ "$#" -gt 1 ] && [[ "$2" != --* ]]; then
        dpi="$2"
        shift 2
      else
        echo "Error: $1 requires a value" >&2
        exit 2
      fi
      ;;
    --help|-h)
      echo "Usage: $0 --forced-dpi <dpi> -- <caelestia args>"
      exit 0
      ;;
    --)
      shift
      cmd=("$@")
      break
      ;;
    *)
      cmd+=("$1"); shift
      ;;
  esac
done

if [ -z "$dpi" ]; then
  echo "Error: --forced-dpi is required" >&2
  exit 2
fi

if ! [[ "$dpi" =~ ^[0-9]+(\.[0-9]+)?$ ]]; then
  echo "Error: invalid DPI value: $dpi" >&2
  exit 2
fi

# compute scale and export minimal env vars then exec caelestia
scale=$(python3 -c "import sys; print(float(sys.argv[1])/96.0)" "$dpi")
export QT_ENABLE_HIGHDPI_SCALING=1
export QT_AUTO_SCREEN_SCALE_FACTOR=0
export QT_SCALE_FACTOR="$scale"
export GDK_DPI_SCALE="$scale"
export CAELESTIA_FORCED_DPI="$dpi"

if [ ${#cmd[@]} -eq 0 ]; then
  # default command if none provided
  cmd=(shell -d)
fi

exec caelestia "${cmd[@]}"